name: ğŸ“Š FII/DII Daily Report

on:
  # â”€â”€ Run every weekday at 6:30 AM IST (1:00 AM UTC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  schedule:
    - cron: "0 1 * * 1-5"   # Monâ€“Fri 6:30 AM IST

  # â”€â”€ Also allow manual trigger from GitHub UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      send_email:
        description: "Send email report?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write        # needed to push docs/ to gh-pages
  pages: write
  id-token: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate-report:
    name: Generate & Deploy FII/DII Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. Checkout repo â€” MUST be first so all files are available
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # 2. Verify expected files exist after checkout
      - name: ğŸ” Verify repo structure
        run: |
          echo "ğŸ“ Repository contents:"
          ls -la
          echo ""
          echo "âœ… Checking required files..."
          test -f requirements.txt && echo "  âœ“ requirements.txt found" || echo "  âœ— requirements.txt MISSING"
          test -f main.py          && echo "  âœ“ main.py found"          || echo "  âœ— main.py MISSING"

      # 3. Set up Python â€” NO cache to avoid requirements.txt lookup issues
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4. Install dependencies directly (no cache, avoids the lookup bug)
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml yfinance pandas numpy python-dotenv

      # 5. Run the dashboard generator
      - name: ğŸš€ Generate FII/DII Dashboard
        env:
          GMAIL_USER:      ${{ secrets.GMAIL_USER }}
          GMAIL_PASS:      ${{ secrets.GMAIL_PASS }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          python main.py

      # 6. Ensure docs/ has required GitHub Pages files
      - name: ğŸ“„ Prepare GitHub Pages folder
        run: |
          mkdir -p docs
          touch docs/.nojekyll
          echo "theme: null" > docs/_config.yml
          echo "docs/ contents:"
          ls -la docs/

      # 7. Commit & push the generated docs/ back to main branch
      - name: ğŸ“¤ Commit & push HTML report
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git diff --cached --quiet && echo "No changes to commit" || \
            git commit -m "ğŸ“Š Auto-report: $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. Deploy docs/ to GitHub Pages (gh-pages branch)
      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token:   ${{ secrets.GITHUB_TOKEN }}
          publish_dir:    ./docs
          publish_branch: gh-pages
          force_orphan:   false
          commit_message: "ğŸŒ Deploy FII/DII Dashboard â€” ${{ github.run_number }}"

      # 9. Print the live GitHub Pages URL
      - name: ğŸ”— Print GitHub Pages URL
        run: |
          REPO="${{ github.repository }}"
          OWNER=$(echo $REPO | cut -d'/' -f1)
          REPONAME=$(echo $REPO | cut -d'/' -f2)
          echo ""
          echo "=========================================="
          echo "âœ… Dashboard live at:"
          echo "   https://${OWNER}.github.io/${REPONAME}/"
          echo "=========================================="

      # 10. Upload report as workflow artifact (downloadable from Actions UI)
      - name: ğŸ“ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: fii-dii-report-${{ github.run_number }}
          path: docs/index.html
          retention-days: 30
