name: ğŸ“Š FII/DII Daily Report

on:
  schedule:
    - cron: "0 1 * * 1-5"   # Monâ€“Fri 6:30 AM IST

  workflow_dispatch:
    inputs:
      send_email:
        description: "Send email report?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    name: Generate & Deploy FII/DII Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. Checkout repo first â€” so ALL files are available
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # 2. Verify files exist
      - name: ğŸ” Verify repo structure
        run: |
          echo "ğŸ“ Repository root contents:"
          ls -la

      # 3. Set up Python â€” NO cache (avoids requirements.txt pre-scan bug)
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4. Install all dependencies inline
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml yfinance pandas numpy python-dotenv pytz

      # 5. Run your script using the CORRECT filename
      - name: ğŸš€ Generate FII/DII Dashboard
        env:
          GMAIL_USER:      ${{ secrets.GMAIL_USER }}
          GMAIL_PASS:      ${{ secrets.GMAIL_PASS }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          python "FII&DII_stock_act.py"

      # 6. Prepare docs/ folder for GitHub Pages
      - name: ğŸ“„ Prepare GitHub Pages folder
        run: |
          mkdir -p docs
          touch docs/.nojekyll
          echo "theme: null" > docs/_config.yml
          echo "ğŸ“ docs/ contents:"
          ls -la docs/

      # 7. Commit & push generated report back to repo
      - name: ğŸ“¤ Commit & push HTML report
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git diff --cached --quiet && echo "No changes to commit" || \
            git commit -m "ğŸ“Š Auto-report: $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. Deploy docs/ to GitHub Pages
      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token:   ${{ secrets.GITHUB_TOKEN }}
          publish_dir:    ./docs
          publish_branch: gh-pages
          force_orphan:   false
          commit_message: "ğŸŒ Deploy FII/DII Dashboard â€” ${{ github.run_number }}"

      # 9. Print live URL
      - name: ğŸ”— Print GitHub Pages URL
        run: |
          REPO="${{ github.repository }}"
          OWNER=$(echo $REPO | cut -d'/' -f1)
          REPONAME=$(echo $REPO | cut -d'/' -f2)
          echo ""
          echo "=========================================="
          echo "âœ… Dashboard live at:"
          echo "   https://${OWNER}.github.io/${REPONAME}/"
          echo "=========================================="

      # 10. Upload artifact
      - name: ğŸ“ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: fii-dii-report-${{ github.run_number }}
          path: docs/index.html
          retention-days: 30
